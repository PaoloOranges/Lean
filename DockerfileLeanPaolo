FROM mcr.microsoft.com/dotnet/sdk:7.0 as builder

RUN apt update && \
    apt install -y git

WORKDIR /SRC

RUN git clone -b custom https://github.com/PaoloOranges/Lean.Brokerages.CoinbasePro.git
COPY . ./Lean
ARG COINBASE_BROKERAGE_PROJECT_PATH=/SRC/Lean.Brokerages.CoinbasePro/QuantConnect.CoinbaseBrokerage/QuantConnect.CoinbaseBrokerage.csproj
ARG LEAN_PROJECT_PATH=/SRC/Lean/Launcher/QuantConnect.Lean.Launcher.csproj

WORKDIR /BUILD

RUN dotnet publish ${COINBASE_BROKERAGE_PROJECT_PATH} -c Release -o LeanPlugins
RUN dotnet publish ${LEAN_PROJECT_PATH} -c Release -o Bin

COPY config-live-coinbase.json config.json

FROM --platform=$TARGETPLATFORM mcr.microsoft.com/dotnet/runtime:6.0
ARG TARGETPLATFORM
ARG BUILDPLATFORM
RUN echo "I am running on $BUILDPLATFORM, building for $TARGETPLATFORM"

WORKDIR /Lean

COPY --from=builder /BUILD/LeanPlugins/QuantConnect.CoinbaseBrokerage.* /Lean/LeanPlugins/
COPY --from=builder /BUILD/Bin /Lean/Bin
COPY --from=builder /BUILD/config.json /Lean/Bin/config.json

WORKDIR /Lean/Bin
ENTRYPOINT [ "dotnet", "/Bin/QuantConnect.Lean.Launcher.dll" ]
