FROM mcr.microsoft.com/dotnet/sdk:9.0 AS builder

WORKDIR /build/src

COPY . Lean

RUN git clone -b custom https://github.com/PaoloOranges/Lean.Brokerages.CoinbasePro.git CoinbaseBrokerage

RUN dotnet publish Lean/DownloaderDataProvider/QuantConnect.DownloaderDataProvider.Launcher.csproj -c Release -o /output && rm -rf src
RUN dotnet publish CoinbaseBrokerage/QuantConnect.CoinbaseBrokerage/QuantConnect.CoinbaseBrokerage.csproj -c Release -o /output && rm -rf Lean.Brokerages.CoinbasePro

RUN cp Lean/DownloaderDataProvider/config.json /output/config.json

RUN rm /output/*.pdb

FROM mcr.microsoft.com/dotnet/runtime:9.0-alpine

ARG EXECUTABLE_PATH=/opt/bin/QuantconnectLeanCoinbaseProTickersDownloader
ARG DOWNLOADER_BIN=$EXECUTABLE_PATH/QuantConnect.DownloaderDataProvider.Launcher.dll

ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false

#Alpine
RUN apk update
RUN apk add icu-libs

WORKDIR $EXECUTABLE_PATH    
COPY --from=builder /output .

ENTRYPOINT [ "dotnet", "QuantConnect.DownloaderDataProvider.Launcher.dll" ]